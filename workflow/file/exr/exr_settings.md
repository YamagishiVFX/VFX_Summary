# EXRの設定の一例と解説

Updated:

2020/05/26
- 一部修正


Created 2020/05/08
-----------------------------

![](https://i.gyazo.com/fa7595cf80724c42ae76d0d0ffc732fe.png)

※ 個人的な設定の公開と解説。「正解」ではなく、普段のプロジェクトなどにおいては環境やワークフローに準じ、**専門家による適切な指示を仰いでください**

※ テクニカルな知識に乏しく、そこまでexrに詳しくなくベンチマークテストなどの明確な数値を把握してる訳ではないので「一例」程度で見ておいて頂けると

※ 記事の内容に一切の責任を持ちません。


## EXRを出力する際に意識したい設定
次の設定に注視

- half precision
- compression
- tiled
- Autocrop
- Overscan

### half_precision：オン
exrのビット数の設定。16bit half float pointを基本としている。特別な理由がない限り今の所は16hfpで事足りている。純粋にデータ量が半分になりパフォーマンスの低下を防ぐことが出来る。ZDepthなどデータを保存する際に足りなくなる場合は必要に応じて32fpで出力している。Deepを使った際の精度は不明。Deepdataだけ出力のためのレンダリングを行う事も。

- ACES ワークフローでも **「カラー情報（シーンの＝自然界の光、色）」を扱うなら16hfpで十分** と今の所されているようだ。ファイルフォーマットも16hfpのexrを指定している。その理由を解説している資料も海外のサイトではいくつか見かける。一方3dcgのポジションやデプスなどの「データ」に関しては不足する事もある。というのが個人の認識。
- ACESワークフローの仕様書では「ACESのAP0のマスターファイルはOpenEXR、16hfpの非圧縮」となっている。
- 3DCGのレンダリングは32bit floating pointで計算されているようだ。

### compression : zip or zips
exrの圧縮設定。zip形式はロスレス方式（可逆圧縮）。zip（16スキャンライン毎）とzips（1スキャンライン毎）の2種類があるのでどちらかを選択。exrで使える可逆圧縮はPLE、ZIP、PIZの三種。VFXではzip系が多く採用されている気がする。NUKE等で画像を展開する際に早いとかあるのだろうか？？ただ、「非圧縮」の方がファイルの展開に時間がかからず早いケースもある。あくまでも体感の話なので、数値的にどれくらい差があるのか？何が最適か？？に関しては不明。一般的にはzipもしくはzipsが採用されている感じがある。何故？zip系が多いのか？の理由については正直な所よく分かっていない。

参考：Pixar Render Man「The Grand Tour: Compositing」
https://renderman.pixar.com/the-grand-tour-compositing
「zip圧縮はFusionでの解凍が非常に高速」という一文があるが、僕個人はどれ位高速なのか？具体的な検証を行ったことがある訳ではないので、具体的な数値などは不明。「Nukeはスキャンラインレンダーであるため、適切な圧縮の選択（zip）が重要」とも。zip(16バンド毎)ではなくzipsと読み取れる（英語力が０に等しく合ってるかは不明）。どうやらコンポジットソフト的にはzips（1スキャンライン毎）が相性がいいらしい。

※非圧縮の方がデータの容量は増えるが「開く」「保存」などデータの展開が早くなるのはどのソフトでもある現象。高解像度のデータをPhotshopで展開する際に非圧縮の方がデータの展開は早い傾向がる。データ量が増えるほどその傾向は顕著になり、データ容量か？速度か？究極の選択に悶える事になる。

### tiled : オフ
exrはデータのタイプに 
- **scanline方式**
- **tiled方式**

の2種類がある。圧縮のタイプのZipの「スキャンライン毎」のスキャンラインの事ではない。NukeのViewMetaDataなどでexrの情報を確認する事が出来る。

![](https://i.gyazo.com/729abc8e5a755e81dfebef9e154f8b88.png)

どちらを選択するのか？は目的によって異なるが、Nukeが基本的に「Tiled」に対応していない。処理がとてもとてもとても遅くなる。出力もTiledの出力が出来ないなどの理由により基本的にScanlineで管理している。僕のワークフローではテクスチャーのちょっとした修正などもNUKEで行う事が多く、とにかく頻繁にNUKEでファイルを開くことになるため。

一方、CGでテクスチャーとして使う際はレンダリング時間短縮など「Tiled」の方が適している事があるようだ。そのため、必要に応じて「Tiled」に変換する。レンダラーの多くのexrの初期設定が「Tiled」なのはそのような理由があるのかもしれない。

参考：[Tiled EXRに関してメモ的なことを記載しようかと(外部リンク)](https://rickeyton.sakura.ne.jp/rickeyton/tiled-exr)

一昔前は、パブリッシュの際にテクスチャの「Tiled化」や「Mipmap化」などをする必要があったが、現在ArnoldなどはTextureをArnold専用の.txに自動で変換するなど最適化を行なってくれる機能があるため、Scanline基本でいいんじゃないか？というのが個人の見解。また、可能であれば3dcgのレンダリングに関しては、レンダリングに可能なテクスチャは色空間の変換も込みで、事前に最適化のパイプラインが構築できるのが望ましい。

AEはTiledでもそこまでパフォーマンスに差を感じなかったので、NUkEを使わないのであればTiledの方がいいという事もあるかもしれない。が、やっぱりデータを引き継いだ時など、一旦NUKEでScanlineに変換をかけてから作業をする必要があるので、広い目ではScanlineが基本がいい気がするが・・・。

- 2D用（コンポジット等作業用）：Scanline
- 3D用 : Tiled（3dcgレンダリングパイプライン用）

と思っておくのがいいのかもしれない。ただ、繰り返しになるがexrをちゃんと理解している訳でも、テクニカルの知識がそこまである訳ではないので「そうらしい」「僕はこうしてる」程度で読んでおいて頂けると。補足や訂正などありましたら遠慮なく言って頂けると大変うれしいです。

### autocrop
![](https://i.gyazo.com/c1e21a39ed19f033674e60222152eac3.png)

exrは「autocrop」というデータの持ち方が可能で、大きな画像の一部しか使っていない時など、この機能を使って保存するとデータの容量を小さくすることが出来、大幅なパフォーマンスの向上を得る事が出来る。

例えば3840x2160 という4Kサイズの出力をする際に、ピクセルのデータが一部の領域しかしなかった場合「その部分だけ保存」みたいな事が可能で、使ってる部分のファイルサイズでくらいで保存したり開いたりする事が出来る。

というとても便利な機能なので「常にオン」にしたくなるが、autocropの画像を読み込みに対応していないツールも多く、対応していないと元の解像度でデータを開く事が出来ない。

3dsmaxは出力の際は対応しているが、入力の対応がされていないので、テクスチャーなどで読み込むとクロップされたサイズで読み込んでしまい、元の状態を再現する事が出来ない。

なので、ワークフローでは「オン」にしても問題が起きないように気を付けて運用する。Nukeでロトマスクした際は、autocropでプロキシを出力して大幅なパフォーマンスの向上を得るというテクもある。

### その他の設定 : ３Ｄのデプスやポジションパス
基本的にはそのままの数値（絶対値）を出力し、シーンによって適切な値の調整（相対値、ノーマライズ）は行わない。ノーマライズする際も、プロジェクト共通で1/100でメートルに変換などで管理している。必要に応じて32fpで出力。exrなのに、従来の整数のフォーマット用のワークフローでノーマライズしてしまうのは、手数もかかったり絶対値が相対値になってしまったり、デミリットの方が多い。データは絶対値で出力し、ノーマライズはコンポジットソフト側などで行う。

Blog内参考記事：[3dcgのデプスのノーマライズ] (https://yamagishi-2bit.blogspot.com/2019/08/aftereffects-3dcg.html)
-------
ファイルの読み書きや展開するまでの時間などはどのように計測したらよいのでしょうか？全くアイディアがないので、何かご存じの方がいらっしゃったら教えて頂けると幸いです
-------
参考：
[半精度浮動小数点の使用によるパフォーマンスの向上](https://www.isus.jp/others/half-precision-floats/)
-------
関連：
[VFXワークフローまとめ](https://yamagishi-2bit.blogspot.com/2019/01/vfx_54.html)